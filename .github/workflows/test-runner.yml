name: Test Self-Hosted Runner

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  test-runner:
    runs-on: [self-hosted, linux, wsl]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Print hostname
        run: hostname

      - name: Run a test script
        run: echo "Hello from self-hosted Linux runner!"

      # ---- START BUILDKIT (REQUIRED FOR NERDCTL) ----
      - name: Start BuildKit (rootless)
        run: |
          export XDG_RUNTIME_DIR=/run/user/$(id -u)
          mkdir -p $XDG_RUNTIME_DIR

          nohup buildkitd-rootless.sh \
            --addr unix:///run/user/$(id -u)/buildkit-default/buildkitd.sock \
            > /tmp/buildkit.log 2>&1 &

          sleep 3

      - name: Configure BuildKit for nerdctl
        run: |
          echo "BUILDKIT_HOST=unix:///run/user/$(id -u)/buildkit-default/buildkitd.sock" >> $GITHUB_ENV
      # ---- END BUILDKIT ----

      # ---- Build Nginx Webapp ----
      - name: Create simple Nginx webapp
        run: |
          mkdir -p webapp
          echo '<!DOCTYPE html><html><body><h1>Hello from Nginx on Kubernetes!</h1></body></html>' > webapp/index.html
          cat <<EOF > webapp/Dockerfile
          FROM nginx:alpine
          COPY index.html /usr/share/nginx/html/index.html
          EOF

      - name: Build Nginx image with nerdctl
        run: nerdctl build -t my-nginx:latest ./webapp

      - name: Push image to local registry (optional)
        run: |
          nerdctl tag my-nginx:latest localhost:5000/my-nginx:latest
          nerdctl push localhost:5000/my-nginx:latest

      - name: Apply Kubernetes deployment
        run: |
          cat <<EOF > webapp/nginx-deployment.yaml
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: nginx-deployment
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: nginx
            template:
              metadata:
                labels:
                  app: nginx
              spec:
                containers:
                  - name: nginx
                    image: localhost:5000/my-nginx:latest
                    ports:
                      - containerPort: 80
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: nginx-service
          spec:
            selector:
              app: nginx
            ports:
              - protocol: TCP
                port: 80
                targetPort: 80
            type: LoadBalancer
          EOF

          kubectl apply -f webapp/nginx-deployment.yaml

      - name: Verify deployment
        run: kubectl get all