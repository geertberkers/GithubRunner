name: Test Self-Hosted Runner

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: [self-hosted, linux, wsl]

    env:
      BUILDKIT_HOST: unix:///run/buildkit/buildkitd.sock

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: System sanity check
        run: |
          hostname
          nerdctl version
          buildctl --version
          kubectl version --client

      # ---- Build Nginx Webapp ----
      - name: Prepare Nginx webapp
        run: |
          rm -rf webapp
          mkdir -p webapp

          cat <<EOF > webapp/index.html
          <!DOCTYPE html>
          <html>
            <body>
              <h1>Hello from Nginx on Kubernetes ðŸš€</h1>
            </body>
          </html>
          EOF

          cat <<EOF > webapp/Dockerfile
          FROM nginx:alpine
          COPY index.html /usr/share/nginx/html/index.html
          EOF

      - name: Build image with nerdctl
        run: nerdctl build -t my-nginx:latest ./webapp

      - name: Push image to local registry
        run: |
          nerdctl tag my-nginx:latest localhost:5000/my-nginx:latest
          nerdctl push localhost:5000/my-nginx:latest

      # ---- Deploy to Kubernetes ----
      - name: Deploy Nginx
        run: |
          kubectl apply -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: nginx-deployment
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: nginx
            template:
              metadata:
                labels:
                  app: nginx
              spec:
                containers:
                - name: nginx
                  image: localhost:5000/my-nginx:latest
                  ports:
                  - containerPort: 80
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: nginx-service
          spec:
            selector:
              app: nginx
            ports:
            - port: 80
              targetPort: 80
          EOF

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/nginx-deployment --timeout=60s

      - name: Verify Nginx is running
        run: |
          kubectl get pods -l app=nginx
          kubectl get svc nginx-service

          POD=$(kubectl get pods -l app=nginx -o jsonpath='{.items[0].metadata.name}')
          kubectl exec "$POD" -- wget -qO- http://localhost:80